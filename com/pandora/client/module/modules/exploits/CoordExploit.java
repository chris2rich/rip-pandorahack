package com.pandora.client.module.modules.exploits;

import com.pandora.api.settings.Setting;
import com.pandora.api.util.misc.MessageBus;
import com.pandora.api.util.world.WorldUtils;
import com.pandora.client.module.Module;
import java.io.File;
import java.io.FileWriter;
import java.io.PrintWriter;
import java.util.HashMap;
import java.util.Iterator;
import net.minecraft.entity.player.EntityPlayer;
import net.minecraft.util.math.Vec3d;

public class CoordExploit extends Module {
   private final HashMap knownPlayers = new HashMap();
   private final HashMap tpdPlayers = new HashMap();
   private int numTicks = 0;
   private int numForgetTicks = 0;
   Setting.Boolean chatMessages;

   public CoordExploit() {
      super("CoordExploit", Module.Category.Exploits);
   }

   public void setup() {
      this.chatMessages = this.registerBoolean("Chat Messages", "ChatMessages", false);
   }

   public void saveFile(String pos, String name) {
      try {
         File file = new File("./Pandora/Misc/CoordExploit.json");
         file.getParentFile().mkdirs();
         PrintWriter writer = new PrintWriter(new FileWriter(file, true));
         writer.println("name: " + name + " coords: " + pos);
         writer.close();
      } catch (Exception var5) {
         MessageBus.sendClientPrefixMessage("Error saving file: " + var5);
      }

   }

   public void onUpdate() {
      if (mc.field_71439_g != null && mc.field_71441_e != null) {
         if (this.numTicks >= 50) {
            this.numTicks = 0;
            Iterator var1 = mc.field_71441_e.field_73010_i.iterator();

            label49:
            while(true) {
               while(true) {
                  if (!var1.hasNext()) {
                     break label49;
                  }

                  EntityPlayer entityPlayer = (EntityPlayer)var1.next();
                  if (entityPlayer == mc.field_71439_g) {
                     return;
                  }

                  Vec3d playerPos = new Vec3d(entityPlayer.field_70165_t, entityPlayer.field_70163_u, entityPlayer.field_70161_v);
                  if (this.knownPlayers.containsKey(entityPlayer)) {
                     if (Math.abs(((Vec3d)this.knownPlayers.get(entityPlayer)).func_72438_d(playerPos)) > 50.0D && Math.abs(mc.field_71439_g.func_174791_d().func_72438_d(playerPos)) > 100.0D && (!this.tpdPlayers.containsKey(entityPlayer.func_70005_c_()) || this.tpdPlayers.get(entityPlayer.func_70005_c_()) != playerPos)) {
                        if (this.chatMessages.getValue()) {
                           MessageBus.sendClientPrefixMessage("Player " + entityPlayer.func_70005_c_() + " has teleported to " + WorldUtils.vectorToString(playerPos));
                        }

                        this.saveFile(WorldUtils.vectorToString(playerPos), entityPlayer.func_70005_c_());
                        this.knownPlayers.remove(entityPlayer);
                        this.tpdPlayers.put(entityPlayer.func_70005_c_(), playerPos);
                     }

                     this.knownPlayers.put(entityPlayer, playerPos);
                  } else {
                     this.knownPlayers.put(entityPlayer, playerPos);
                  }
               }
            }
         }

         if (this.numForgetTicks >= 9000000) {
            this.tpdPlayers.clear();
         }

         ++this.numTicks;
         ++this.numForgetTicks;
      }
   }
}
