package com.pandora.client.module.modules.exploits;

import com.pandora.api.event.events.DamageBlockEvent;
import com.pandora.api.settings.Setting;
import com.pandora.client.PandoraMod;
import com.pandora.client.module.Module;
import java.util.ArrayList;
import java.util.function.Predicate;
import me.zero.alpine.listener.EventHandler;
import me.zero.alpine.listener.Listener;
import net.minecraft.block.Block;
import net.minecraft.block.state.IBlockState;
import net.minecraft.client.Minecraft;
import net.minecraft.init.MobEffects;
import net.minecraft.network.play.client.CPacketPlayerDigging;
import net.minecraft.network.play.client.CPacketPlayerDigging.Action;
import net.minecraft.potion.PotionEffect;
import net.minecraft.util.EnumHand;
import net.minecraft.util.math.BlockPos;

public class FastBreak extends Module {
   Setting.Mode mode;
   Setting.Boolean haste;
   @EventHandler
   private final Listener<DamageBlockEvent> listener = new Listener((event) -> {
      if (mc.field_71441_e != null && mc.field_71439_g != null) {
         if (this.canBreak(event.getPos())) {
            if (this.mode.getValue().equalsIgnoreCase("Packet")) {
               mc.field_71439_g.func_184609_a(EnumHand.MAIN_HAND);
               mc.field_71439_g.field_71174_a.func_147297_a(new CPacketPlayerDigging(Action.START_DESTROY_BLOCK, event.getPos(), event.getFace()));
               mc.field_71439_g.field_71174_a.func_147297_a(new CPacketPlayerDigging(Action.STOP_DESTROY_BLOCK, event.getPos(), event.getFace()));
               event.cancel();
            }

            if (this.mode.getValue().equalsIgnoreCase("Damage") && mc.field_71442_b.field_78770_f >= 0.7F) {
               mc.field_71442_b.field_78770_f = 1.0F;
            }

            if (this.mode.getValue().equalsIgnoreCase("Instant")) {
               mc.field_71439_g.func_184609_a(EnumHand.MAIN_HAND);
               mc.field_71439_g.field_71174_a.func_147297_a(new CPacketPlayerDigging(Action.START_DESTROY_BLOCK, event.getPos(), event.getFace()));
               mc.field_71439_g.field_71174_a.func_147297_a(new CPacketPlayerDigging(Action.STOP_DESTROY_BLOCK, event.getPos(), event.getFace()));
               mc.field_71442_b.func_187103_a(event.getPos());
               mc.field_71441_e.func_175698_g(event.getPos());
            }
         }

      }
   }, new Predicate[0]);

   public FastBreak() {
      super("SpeedMine", Module.Category.Misc);
   }

   public void setup() {
      ArrayList<String> Modes = new ArrayList();
      Modes.add("Packet");
      Modes.add("Damage");
      Modes.add("Instant");
      this.mode = this.registerMode("Mode", "Mode", Modes, "Packet");
      this.haste = this.registerBoolean("Haste", "Haste", false);
   }

   public void onUpdate() {
      Minecraft.func_71410_x().field_71442_b.field_78781_i = 0;
      if (this.haste.getValue()) {
         PotionEffect effect = new PotionEffect(MobEffects.field_76422_e, 80950, 1, false, false);
         mc.field_71439_g.func_70690_d(new PotionEffect(effect));
      }

      if (!this.haste.getValue() && mc.field_71439_g.func_70644_a(MobEffects.field_76422_e)) {
         mc.field_71439_g.func_184589_d(MobEffects.field_76422_e);
      }

   }

   private boolean canBreak(BlockPos pos) {
      IBlockState blockState = mc.field_71441_e.func_180495_p(pos);
      Block block = blockState.func_177230_c();
      return block.func_176195_g(blockState, mc.field_71441_e, pos) != -1.0F;
   }

   public void onEnable() {
      PandoraMod.EVENT_BUS.subscribe((Object)this);
   }

   public void onDisable() {
      PandoraMod.EVENT_BUS.unsubscribe((Object)this);
      mc.field_71439_g.func_184589_d(MobEffects.field_76422_e);
   }
}
